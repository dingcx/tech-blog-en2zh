# 15.InnoDB简介

```
译者：徐晨亮

团队：无名队

说明：转载请注明出处
```

[TOC]

InnoDB是一种兼于高可靠性和高性能的通用存储引擎。在MySQL8.0中，InnoDB是默认的存储引擎。除非你配置了不同的默认存储引擎，否则在CREATE TABLE时不带ENGINE=子句时都会创建InnoDB表。

## InnoDB的主要优势

- DML操作遵循ACID模型，具有提交、回滚和崩溃恢复功能的实务来保护用户数据。
- 行级锁定和Oracle风格的一致性读取可提高多用户并发性和性能。
- InnoDB表将你的数据排列在磁盘上，以根据主键优化查询。每个InnoDB表都有一个称为聚集索引的主键索引，为主键查询最小化I/O来组织数据。
- 要保持数据完整性，InnoDB支持外键约束。使用外键，将检查插入，更新和删除，以确保它们不会导致不同表之间的不一致。

表15.1InnoDB存储引擎功能

| 特征                                                  | 支持                                                         |
| ----------------------------------------------------- | ------------------------------------------------------------ |
| 备份/时间点恢复（在服务器中实现，而不是在存储引擎中） | 是                                                           |
| 集群数据库支持                                        | 没有                                                         |
| 聚集索引                                              | 是                                                           |
| 压缩数据                                              | 是                                                           |
| 数据缓存                                              | 是                                                           |
| 加密数据                                              | 是（通过加密功能在server层实现；在MySQL5.7级更高的版本中，支持静态数据表空间加密） |
| 外键支持                                              | 是                                                           |
| 全文搜索索引                                          | 是（在MySQL5.6及更高版本中可以使用InnoDB对FULLTEXT索引的支持） |
| 地理空间数据类型支持                                  | 是                                                           |
| 地理空间索引支持                                      | 是（在MySQL5.7及更高版本中可以使用InnoDB对地理空间索引的支持） |
| 哈希索引                                              | 否（InnoDB在内部利用哈希索引来实现其自适应哈希索引功能）     |
| 索引缓存                                              | 是                                                           |
| 锁定粒度                                              | 行                                                           |
| MVCC                                                  | 是                                                           |
| 复制支持                                              | 是                                                           |
| 存储限制                                              | 64TB                                                         |
| T树索引                                               | 没有                                                         |
| 事务支持                                              | 是                                                           |
| 更新数据字典的统计信息                                | 是                                                           |

##InnoDB增强功能和新功能

有关InnoDB增强功能和新功能的信息，请参阅：

- "[MySQL8.0中的新InnoDB功能](https://dev.mysql.com/doc/refman/8.0/en/mysql-nutshell.html)"中的增强功能列表
- [发行说明](https://dev.mysql.com/doc/relnotes/mysql/8.0/en/)

## 额外的InnoDB信息和资源

- 有关InnoDB相关术语和定义吗，请参阅[MySQL词汇表](https://dev.mysql.com/doc/refman/8.0/en/glossary.html)
- 对于专用于InnoDB存储引擎的论坛，请参阅[MySQL论坛::InnoDB](http://forums.mysql.com/list.php?22)

## 15.1 使用InnoDB表的好处

使用InnoDB表你可能会发现以下好处：

- 如果你的服务器由于硬件或者软件问题崩溃，无论当时数据库中发生了什么，你都无需在重新启动数据库后执行任何特殊操作。InnoDB崩溃恢复回自动完成崩溃之前提交的所有变更，并撤销正在进行但仍未提交的任何变更。只需要在你离开的地方重启并继续。
- InnoDB存储引擎维护了自己的缓冲池，在主要的内存中当数据被访问时用来缓冲表和索引数据。频繁被使用的数据直接从内存读取处理。此缓存适用于许多类型的信息并加快处理速度。在专用数据库服务器上，通常会将最多80%的物理内存分配给缓冲池。
- 如果将相关数据拆分到不同的表中，则可以设置外键以此来强制引用完整性。更新或删除数据，其他表上的相关数据也将会自动更新或删除。尝试将主表上没有的数据插入到子表中，那么错误的数据将会自动剔除。
- 如果数据在磁盘或内存中损坏，checksum机制将会提醒你在使用前伪造数据。
- 当设计数据库为每个表设定合适的主键列，涉及到这些列的操作将会自动优化。在WHERE子句，ORDER BY子句，GROUP BY子句和join操作时使用主键会非常快。
- 插入，更新和删除将会由change buffer机制进行优化。InnoDB不仅允许对同一个表进行并发读写访问，还可以缓存已经更改的数据以简化磁盘I/O。
- 性能优势不仅仅局限于在超大表上运行长时间的查询。当一个表上的相同行被一次又一次地访问，AHI特性将会使这些操作变得非常快就像它们来自哈希表一样。
- 你可以使用压缩表和关联的索引。
- 你可以创建或者删除索引，并且对性能和可用性的影响非常小。
- truncate每个独立表空间非常快，并且可以将释放的空间给操作系统使用，而系统表空间释放的空间只能给InnoDB重用。
- 在Dynamic的行格式下，对`BLOB`和`long text`字段存储表数据的方式将更有效。
- 你可以通过查询`INFORMATION_SCHEMA`表来监控存储引擎的内部工作方式
- 你可以通过查询`performance schema`来监控存储引擎的性能详情
- 你可以自由地混合InnoDB表和其他引擎表，甚至可以在同一语句中。例如，你可以在一个简单查询中使用join操作来组合InnoDB和MEMORY表数据。
- InnoDB是为在处理大量数据提升cpu效率和最大化性能而设计
- InnoDB表可以处理大量数据，即使在文件大小限制为2GB的操作系统上也是如此。

对于InnoDB你可以在应用程序代码中使用InnoDB特定的优化技术，可以参照[Optimizing for InnoDB Tables](https://dev.mysql.com/doc/refman/8.0/en/optimizing-innodb.html)

## 15.1.2 InnoDB表最佳实践

本节介绍使用InnoDB表的最佳实践

- 为每个表在最常用的单列或多列创建主键，如果没有明显的主键，则指定一个自增的值
- 基于ID从多个表获取数据时使用join。为了获得快速连接性能，在join列上定义外键并且在每个表上定义这些列时声明相同的数据类型。添加外键可以确保引用的列建立索引从而提高性能。外键还会将删除或更新操作广播到所有受影响的表上，并且如果父表中不存在相应的ID，会阻止在子表中插入数据。
- 关闭自动提交。每秒几百次的提交限制性能（受存储设备写入速度的限制）
- 通过START TRANSACTION和COMMIT语句将相关的DML操作放到一组事务中。当你不想频繁地提交，你也不想发出大批量的INSERT，UPDATE或者DELETE而跑几个小时并且不提交。
- 不要使用LOCK TABLES语句。InnoDB能够同时处理多个会话，同时读取和写入同一个表，而不会牺牲可靠性或高性能。要获得对同一组行的排他写权限，请使用SELECT … FOR UPDATE语法来锁定你想更新的行。
- 使用独立表空间或者使用通用表空间的多个文件来存放数据和索引，而不是系统表空间。innodb_file_per_table选项是默认的。
- 评估你的数据和访问模式是否受益于InnoDB表或页面压缩功能。你可以在InnoDB不牺牲读/写功能的情况下使用压缩表。
- 使用`--sql_mode=NO_ENGINE_SUBSTITUTION`选项来运行你的MySQL，避免在CREATE TABLE使用ENGINE=子句中指定的引擎出现问题时使用其他存储引擎来创建表。

## 15.1.3确认InnoDB是默认的存储引擎

使用`SHOW ENGINES`语句可以查看可用的MySQL存储引擎。查看DEFAULT是否InnoDB所在行

```mysql
mysql>SHOW ENGINES;
```

或者，可以查询`INFORMATION_SCHEMA.ENGINES`表

```mysql
mysql>SELECT * FROM INFORMATION_SCHEMA.ENGINES;
```

## 15.1.4测试和压测InnoDB

如果InnoDB不是你的默认存储引擎，那么可以通过重启server并且在命令行中指定`--default-storage-engine=InnoDB`或者在MySQL配置文件的[mysqld]部分定义`default-storage-engine=innodb`来确定你的数据库服务器或者应用程序是否正确使用了InnoDB。

由于更改默认存储引擎只会影响新创建的表，因此请运行所有程序安装步骤确保正确安装。然后测试所有的程序特性来确保所有的数据加载，编辑和查询特性都能工作。如果一个表依赖于其他引擎的特性，你将会收到错误提示。在CREATE TABLE语句中添加ENGINE=other_engine_name子句来避免错误。

如果你没有对存储引擎做出深思熟虑的决定，并且想要预览某些特定InnoDB表如何工作，为每个表使用命令`ALTER TABLE table_name ENGINE=InnoDB`;或者，在不打扰原始表的情况下运行测试查询和其他语句，请复制：

```mysql
CREATE TABLE InnoDB_Table (...) ENGINE=InnoDB AS SELECT * FROM other_engine_table;
```

要在实际工作负载下评估完整应用程序性能，请安装最新的MySQL服务器并运行基准测试。

测试应用的完整生命周期，从安装到大量使用，服务重启。在数据库忙于模拟电源故障时终止服务器进程，并在重新启动服务器时验证数据是否已成功恢复。

测试任何复制配置，尤其是你在master和slave上使用不同的MySQL版本和选项。